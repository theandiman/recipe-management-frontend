# Cloud Build configuration for deploying the infrastructure project
# This is a special bootstrap deployment that creates the infra project itself
# Run this FIRST before other Terraform deployments

steps:
  # Step 1: Initialize Terraform (local state for bootstrap)
  - name: 'hashicorp/terraform:1.6'
    id: 'terraform-init'
    args:
      - 'init'
    dir: 'terraform/environments/infra'
    env:
      - 'TF_VAR_billing_account=${_BILLING_ACCOUNT}'
      - 'TF_VAR_org_id=${_ORG_ID}'
      - 'TF_VAR_folder_id=${_FOLDER_ID}'

  # Step 2: Validate Terraform configuration
  - name: 'hashicorp/terraform:1.6'
    id: 'terraform-validate'
    args:
      - 'validate'
    dir: 'terraform/environments/infra'

  # Step 3: Plan Terraform changes
  - name: 'hashicorp/terraform:1.6'
    id: 'terraform-plan'
    args:
      - 'plan'
      - '-out=tfplan'
    dir: 'terraform/environments/infra'
    env:
      - 'TF_VAR_billing_account=${_BILLING_ACCOUNT}'
      - 'TF_VAR_org_id=${_ORG_ID}'
      - 'TF_VAR_folder_id=${_FOLDER_ID}'

  # Step 4: Apply Terraform
  - name: 'hashicorp/terraform:1.6'
    id: 'terraform-apply'
    args:
      - 'apply'
      - '-auto-approve'
      - 'tfplan'
    dir: 'terraform/environments/infra'
    env:
      - 'TF_VAR_billing_account=${_BILLING_ACCOUNT}'
      - 'TF_VAR_org_id=${_ORG_ID}'
      - 'TF_VAR_folder_id=${_FOLDER_ID}'

  # Step 5: Output configuration
  - name: 'hashicorp/terraform:1.6'
    id: 'terraform-output'
    args:
      - 'output'
    dir: 'terraform/environments/infra'

# Substitution variables
substitutions:
  _BILLING_ACCOUNT: ''  # Required: Your billing account ID
  _ORG_ID: ''           # Optional: Organization ID (use this OR folder_id)
  _FOLDER_ID: ''        # Optional: Folder ID (use this OR org_id)

# This bootstrap deployment needs project creator permissions at org/folder level
# Run from a project that has these permissions, or use your user credentials locally

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'N1_HIGHCPU_8'

timeout: '1200s'
